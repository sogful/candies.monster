<!DOCTYPE html>
<html lang="en">
<head>
    <title>Music Player!</title>
    <link rel="icon" type="image/png" href="/assets/images/player/favicon.png">

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta property="og:image" content="/assets/images/banner.png">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="/assets/images/banner.png">

    <!-- search engines (practically no one is gonna find this through google but still) -->
    <meta name="robots" content="index, follow, max-snippet:120, max-image-preview:large, max-video-preview:5">
    <meta name="googlebot" content="index, follow, max-snippet:120, max-image-preview:large, max-video-preview:5">
    <meta name="bingbot" content="index, follow">
    <meta name="keywords" content="cut the rope, cut the rope modding, cut the rope home, level browser, game, walkthrough, tips, ios, android game">

    <style>

        @font-face {
            font-family: "Good Dog";
            src: url("/assets/fonts/gooddog.woff");
        }

        body {
            font-family: "Good Dog"; background-color: black;
            min-height: 100vh; overflow-x: hidden;
            user-select: none; cursor: url("/assets/static/idle.cur"), default !important;
            position: relative;
        }
        
        .stupidbg {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-size: cover; background-attachment: fixed;
            background-position: center; background-repeat: no-repeat;
            transition: opacity 0.5s ease-in-out; 
            z-index: -1; filter: brightness(0.25) blur(2px);
        }
        body:active, body:focus, body:focus-within, body:target, body:active * {
            cursor: url("/assets/static/active.cur"), default !important;
        }
        :any-link {
            color: #8feeff; text-decoration: none !important;
            cursor: url("/assets/static/link.cur"), default !important;
        }
        * {
            margin: 0; padding: 0;
            box-sizing: border-box;
        }
        *::-webkit-scrollbar {width: 0px}

        .loading {
            position: fixed; display: flex;
            justify-content: center; align-items: center;
            width: 100vw; height: 100vh;
            z-index: 65535; background-color: rgba(0,0,0,0.8);
            transition: opacity 0.5s;
        }

        .loading svg {
            width: 100px;
            animation: rotate 2s linear infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /*//////////////////////////////////////////////////////////////////////*/

        .songlistcontainer {
            padding: 2em; max-width: 1200px;
        }

        .songlist {
            display: flex; flex-wrap: wrap;
            justify-content: flex-start; gap: 1em;
        }
        .songblockheader {
            display: flex; align-items: center;
            gap: 0.3em; padding-bottom: 0.5em;
        }
        .songblockicon {width: 1.25em; height: 1.25em; border-radius: 0.2em}
        .songblocktitle {
            color: white; font-size: 1em;
            text-shadow: 0 1px 0 black;
            -webkit-text-stroke: 0.13em black;
            text-shadow: 0 0.13em 0 black;
            paint-order: stroke fill;
        }

        .songitem {
            display: flex; flex-direction: column;
            padding: 0em 0.5em; border-radius: 1em;
            transition: background-color 0.2s; /* no other buttons on the site have smooth effect but it just fits here */
        }
        .songitem:hover {background-color: rgba(255, 255, 255, 0.05)}
        .songnamecontainer {
            display: flex; align-items: center;
            justify-content: space-between; gap: 0.5em;
        }
        .songname {
            color: white; font-size: 0.75em;
            -webkit-text-stroke: 0.2em black;
            text-shadow: 0 0.05em 0 black;
            paint-order: stroke fill;
        }
        .downloadbuttons {
            display: flex; gap: 0.25em;
        }
        .downloadbutton {
            width: 1.5em; height: 2em;
            background: none; border: none;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            border-radius: 0.25em; font-size: 0.75em;
            transition: background-color 0.2s;
        }
        .downloadbutton img:hover {background-color: rgba(255, 255, 255, 0.2)}
        .downloadbutton img {width: 1em; height: 1em}
        .extensionlabel {
            color: white; font-family: "Good Dog";
            font-size: 0.6em; margin-bottom: 2px;
            -webkit-text-stroke: 0.2em black;
            text-shadow: 0 0.05em 0 black;
            paint-order: stroke fill;
        }

        /*//////////////////////////////////////////////////////////////////////*/

        .subcategory {
            margin-left: 1em;
        }
        .subcategoryheader {
            display: flex; align-items: center;
            gap: 0.5em;
        }
        .subcategorytitle {
            color: white; font-size: 0.75em;
            text-shadow: 0 1px 0 black;
        }

        /*//////////////////////////////////////////////////////////////////////*/

        .controlbar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0));
            padding: 15px 15px; display: flex;
            align-items: center; gap: 5px; z-index: 1000;
            height: 80px;
        }
        .controlbar img {width: 2em !important; height: 2em !important}

        .controlbutton {
            width: 40px; height: 40px; border-radius: 50%;
            background: none; border: none; display: flex;
            align-items: center; justify-content: center;
            
        }

        .controlbutton:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /*//////////////////////////////////////////////////////////////////////*/

        .playbackmodes {display: flex; gap: 5px}
        .modebutton {
            width: 40px; height: 40px; border-radius: 50%; 
            background: none; border: none; display: flex;
            align-items: center; justify-content: center;
        }

        .modebutton:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .modebutton.active {
            background-color: rgba(143, 238, 255, 0.2);
        }

        /*//////////////////////////////////////////////////////////////////////*/

        .timedisplay {
            color: white; font-size: 1.5em;
            text-align: center; width: 5em;
            -webkit-text-stroke: 0.13em black;
            text-shadow: 0 0.13em 0 black;
            paint-order: stroke fill;
        }

        .progresscontainer {
            flex: 1; display: flex;
            align-items: center; height: 20px;
            position: relative;
        }
        .progressbar {
            width: 100%; height: 20px;
            position: relative; 
        }

        .progressbody {
            width: 100%; height: 100%;
            position: relative; display: flex;
        }
        .progressleft {
            width: 20px; height: 20px;
            background: url("/assets/images/player/progress/leftbody.png") no-repeat center;
            background-size: contain; flex-shrink: 0;
        }
        .progresscenter {
            flex: 1; height: 20px;
            background: url("/assets/images/player/progress/body.png") repeat-x center;
            background-size: auto 100%;
        }
        .progressright {
            width: 20px; height: 20px;
            background: url("/assets/images/player/progress/rightbody.png") no-repeat center;
            background-size: contain; flex-shrink: 0;
        }

        .progressfillcontainer {
            position: absolute; top: 0;
            left: 0; height: 100%;
            overflow: hidden; border-radius: 1em;
            padding: 2px; width: 0%;
        }
        .progressfill {
            height: 16px; background: url("/assets/images/player/progress/fill.png") repeat-x center;
            background-size: auto 100%; border-radius: 0.5em;
            z-index: 9999; width: 100%; min-width: 1em;
        }

        /*//////////////////////////////////////////////////////////////////////*/

        .fullscreenbutton {
            width: 40px; height: 40px;
            background: none; border: none;
             display: flex;
            align-items: center; justify-content: center;
            border-radius: 50%;
        }

        .fullscreenbutton:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .fullscreenbutton img {
            width: 24px; height: 24px;
            filter: brightness(0) invert(1);
        }
    </style>
</head>
<body>
    <div class="stupidbg"></div>
    <audio class="audioplayer" preload="auto"></audio>
    <audio class="click" src="/assets/audio/tap.mp3" preload="auto"></audio>
    
    <div class="loading">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200">
            <path fill="#fbfbfb" d="M89 15h22l17 4 14 6 10 7 10 9 9 11 6 11 4 9 3 14 1 9v9l-3 19-5 14-8 13-11 12-9 8-17 9-21 5H89l-18-4-16-8-6-4-10-9-9-10-6-10-6-16-2-9-1-17 2-16 4-14 5-10 6-9 9-10 9-8 16-9 18-5Zm1 18-12 3-16 8-7 6v1l17 1 13 4 9 6 6 8 3 7v5l-4 1-9-6-4-1H74l-6 2-8 4-9 6-8 11-5 16-1 8 6 12 7 9h2l9-19 10-14 9-10 7-5 3-1h7l-1 5-7 6-4 8-2 6v13l4 14 7 9 6 5 8 4h8l14-5 10-7 4-4-21-9-8-6-7-7-5-10-2-8v-8l5-1 5 9 7 6 11 2 13-3 11-6 9-8 4-6v-8l-6-17-7-10-5-5-5 12-6 10-8 10-10 8-5 1-1-5 6-13 1-4V59l-4-10-6-9-8-7Z"/>
            <path fill="#080808" d="M90 29h13l8 7 7 8 5 10 1 6v14l-4 11-3 5 8-6 8-9 7-12 5-16 4 1 9 10 8 15 4 13v9l-8 11-11 8-12 5-4 1h-15l-6-3-7-6-2-4 2 10 7 11 7 6 9 5 16 6 6 1-2 4-12 10-15 7-7 2h-9l-10-5-8-7-7-12-3-11v-15l4-10 4-6 3-4-10 8-9 10-9 15-8 20-4-2-9-10-8-16v-8l5-16 6-11 8-7 10-6 12-4h12l10 4 3 1-5-9-8-7-10-4-5-1H45l4-6 12-10 16-8 6-2Zm0 4-12 3-16 8-7 6v1l17 1 13 4 9 6 6 8 3 7v5l-4 1-9-6-4-1H74l-6 2-8 4-9 6-8 11-5 16-1 8 6 12 7 9h2l9-19 10-14 9-10 7-5 3-1h7l-1 5-7 6-4 8-2 6v13l4 14 7 9 6 5 8 4h8l14-5 10-7 4-4-21-9-8-6-7-7-5-10-2-8v-8l5-1 5 9 7 6 11 2 13-3 11-6 9-8 4-6v-8l-6-17-7-10-5-5-5 12-6 10-8 10-10 8-5 1-1-5 6-13 1-4V59l-4-10-6-9-8-7Z"/>
            <path fill="#060606" d="M89 15h22l17 4 14 6 10 7 10 9 9 11 6 11 4 9 3 14 1 9v9l-3 19-5 14-8 13-11 12-9 8-17 9-21 5H89l-18-4-16-8-6-4-10-9-9-10-6-10-6-16-2-9-1-17 2-16 4-14 5-10 6-9 9-10 9-8 16-9 18-5Zm4 3-16 3-16 7-11 7-11 10-8 11-8 16-3 12-1 7v17l2 12 5 14 6 11 9 11 10 9 15 9 14 5 11 2h18l13-3 14-5 14-9 12-11 9-13 7-16 2-7 1-9V90l-3-15-7-16-8-11-8-9-12-9-17-8-12-3-7-1Z"/>
          </svg>          
    </div>

    <div class="songlistcontainer">
        <div class="songlist"></div>
    </div>

    <div class="controlbar">
        <button class="controlbutton playpausebutton clickable">
            <img src="/assets/images/player/icons/play.png">
        </button>
        
        <button class="controlbutton prevbutton clickable">
            <img src="/assets/images/player/icons/previous.png">
        </button>
        
        <button class="controlbutton nextbutton clickable">
            <img src="/assets/images/player/icons/next.png">
        </button>
        
        <div class="playbackmodes">
            <button class="modebutton active loopallbutton clickable">
                <img src="/assets/images/player/icons/loop.png">
            </button>
            <button class="modebutton shufflebutton clickable">
                <img src="/assets/images/player/icons/shuffle.png">
            </button>
        </div>
        <div class="timedisplay">??:??/??:??</div>
        
        <div class="progresscontainer">
            <div class="progressbar">
                <div class="progressbody">
                    <div class="progressleft"></div>
                    <div class="progresscenter"></div>
                    <div class="progressright"></div>
                </div>
                <div class="progressfillcontainer">
                    <div class="progressfill"></div>
                </div>
            </div>
        </div>
        
        <button class="fullscreenbutton clickable">
            <img src="/assets/images/player/icons/fullscreen.png">
        </button>
    </div>

    <script>
        
        var haspaintorder = false;
        var haswebkitstroke = false;
        if (window.CSS && CSS.supports) {
            haspaintorder = CSS.supports("paint-order", "stroke fill");
            haswebkitstroke = CSS.supports("-webkit-text-stroke", "1px black");
        }
        if (!haspaintorder || !haswebkitstroke) {
            var style = document.createElement("style");
            style.textContent = `h1, h2, h3, h4, h5, h6, a, span, div {
                paint-order: unset !important;
                -webkit-text-stroke: 0 !important;
                text-shadow: -0.1em 0 black, 0 0.1em black, 0.1em 0 black, 0 -0.1em black,
                -0.07em 0.07em black, 0.07em 0.07em black, -0.07em -0.07em black,
                0.07em -0.07em black, 0 0.15em 0 black !important;
            }`;
            document.head.appendChild(style);
        }

        // click sfx
        document.querySelectorAll(".clickable").forEach(function(element) {
            element.addEventListener("click", function() {
                document.querySelector(".click").currentTime = 0;
                document.querySelector(".click").play();
            });
        });

        /*//////////////////////////////////////////////////////////////////////*/

        // you are the most vibecoded page EVER!
        class musicplayer {
            constructor() {
                this.audio = document.querySelector(".audioplayer");
                this.nextAudio = document.createElement("audio");
                this.nextAudio.preload = "auto";
                this.songs = [
                    {
                        category: "Candy Flick",
                        icon: "candyflick.webp",
                        tracks: [
                            { path: "candyflick/menu_music.mp3",
                              formats: ["mp3"],
                              background: "candyflick.webp"
                            }
                        ]
                    },
                    {
                        category: "Cut the Rope",
                        icon: "original.webp",
                        tracks: [
                            { path: "ctr/game_music.ogg",
                              formats: ["ogg"],
                              background: "cardboard.webp"
                            },
                            { path: "ctr/menu_music.ogg",
                              formats: ["ogg"],
                              background: "menu.webp"
                            },
                        ]
                    },
                    {
                        category: "Cut the Rope 2",
                        icon: "ctr2.webp",
                        tracks: [
                            { path: "ctr2/game_music_1.ogg",
                              formats: ["ogg"],
                              background: "two1.webp"
                            },
                            { path: "ctr2/game_music_2.ogg",
                              formats: ["ogg"],
                              background: "two2.webp"
                            },
                            { path: "ctr2/game_music_3.ogg",
                              formats: ["ogg"],
                              background: "two4.webp"
                            },
                            { path: "ctr2/menu_music.ogg",
                              formats: ["ogg"],
                              background: "twomenu.webp"
                            }
                        ]
                    },
                    {
                        category: "Daily",
                        icon: "daily.webp",
                        tracks: [
                            { path: "daily/game_music.ogg",
                              formats: ["ogg"],
                              background: "daily.webp"
                            },
                            { path: "daily/record_rotating_right_02.ogg",
                              formats: ["ogg"],
                              background: "daily.webp"
                            }
                        ]
                    },
                    {
                        category: "Holiday Gift",
                        icon: "holidaygift.webp",
                        tracks: [
                            { path: "holidaygift/game_music.ogg",
                              formats: ["ogg"],
                              background: "holidaybox.webp"
                            },
                            { path: "holidaygift/menu_music.ogg",
                              formats: ["ogg"],
                              background: "holidaymenu.webp"
                            }
                        ]
                    },
                    {
                        category: "Idle Candy",
                        icon: "idlecandy.webp",
                        tracks: [
                            { path: "idlecandy/frenzy_mode.ogg",
                              formats: ["ogg"],
                              background: "menu.webp"
                            },
                            { path: "idlecandy/game_music_01.ogg",
                              formats: ["ogg"],
                              background: "cardboard.webp"
                            },
                            { path: "idlecandy/game_music_02.ogg",
                              formats: ["ogg"],
                              background: "cardboard.webp"
                            }
                        ]
                    },
                    {
                        category: "Magic",
                        icon: "magic.webp",
                        tracks: [
                            { path: "magic/boss_game_music.ogg",
                              formats: ["ogg"],
                              background: "menu.webp"
                            },
                            { path: "magic/game_music_1.ogg",
                              formats: ["ogg"],
                              background: "magic1.webp"
                            },
                            { path: "magic/game_music_2.ogg",
                              formats: ["ogg"],
                              background: "magic2.webp"
                            },
                            { path: "magic/game_music_3.ogg",
                              formats: ["ogg"],
                              background: "magic3.webp"
                            },
                            { path: "magic/game_music_4.ogg",
                              formats: ["ogg"],
                              background: "magic4.webp"
                            },
                            { path: "magic/menu_music.ogg",
                              formats: ["ogg"],
                              background: "magicmenu.webp"
                            }
                        ]
                    },
                    {
                        category: "Merge",
                        icon: "merge.webp",
                        tracks: [
                            { path: "merge/MU_BOSS.ogg",
                              formats: ["ogg"],
                              background: "merge.webp"
                            },
                            { path: "merge/MU_FOREST_AUTUMN.ogg",
                              formats: ["ogg"],
                              background: "merge.webp"
                            },
                            { path: "merge/MU_FOREST_SUMMER.ogg",
                              formats: ["ogg"],
                              background: "merge.webp"
                            },
                            { path: "merge/MU_FOREST_WINTER.ogg",
                              formats: ["ogg"],
                              background: "merge.webp"
                            }
                        ]
                    },
                    {
                        category: "My Om Nom",
                        icon: "myomnom.webp",
                        tracks: [
                            { path: "myomnom/dance_3.mp3",
                              formats: ["mp3"],
                              background: "disco.webp"
                            },
                            { path: "myomnom/dance_4.mp3",
                              formats: ["mp3"],
                              background: "disco.webp"
                            },
                            { path: "myomnom/disco_theme.mp3",
                              formats: ["mp3"],
                              background: "disco.webp"
                            },
                            { path: "myomnom/home_theme.mp3",
                              formats: ["mp3"],
                              background: "mainroom.webp"
                            },
                            { path: "myomnom/match3_theme_variant_2.mp3",
                              formats: ["mp3"],
                              background: "match3.webp"
                            },
                            { path: "myomnom/omnon_pechenki.mp3",
                              formats: ["mp3"],
                              background: "memory.webp"
                            },
                            { path: "myomnom/space_ride_theme.mp3",
                              formats: ["mp3"],
                              background: "space.webp"
                            },
                            { path: "myomnom/urban_theme.mp3",
                              formats: ["mp3"],
                              background: "disco.webp"
                            }
                        ]
                    },
                    {
                        category: "Ringtone",
                        icon: "ctrnet.webp",
                        tracks: [
                            { path: "ringtone/cuttherope_level_theme.mp3",
                              formats: ["mp3"],
                              background: "birthday.webp"
                            },
                            { path: "ringtone/cuttherope_main_theme.mp3",
                              formats: ["mp3"],
                              background: "birthday.webp"
                            },
                            { path: "ringtone/cuttherope_movie_theme.mp3",
                              formats: ["mp3"],
                              background: "birthday.webp"
                            }
                        ]
                    },
                    {
                        category: "Time Travel",
                        icon: "timetravel.webp",
                        tracks: [
                            { path: "timetravel/disco_loop.ogg",
                              formats: ["ogg"],
                              background: "discott.webp"
                            },
                            { path: "timetravel/music_game.ogg",
                              formats: ["ogg"],
                              background: "timetravel1.webp"
                            },
                            { path: "timetravel/music_menu.ogg",
                              formats: ["ogg"],
                              background: "timetravelmenu.webp"
                            }
                        ]
                    },
                    {
                        category: "Triple Treat",
                        icon: "tripletreat.webp",
                        tracks: [
                            { path: "tripletreat/menu_music.mp3",
                              formats: ["mp3", "dspadpcm.bcstm"],
                              background: "menu.webp"
                            }
                        ],
                        subcategories: [
                            {
                                name: "Classic",
                                tracks: [
                                    { path: "tripletreat/classic/game_music.mp3",
                                      formats: ["mp3", "dspadpcm.bcstm"],
                                      background: "cardboard.webp"
                                    },
                                    { path: "tripletreat/classic/menu_music.mp3",
                                      formats: ["mp3", "dspadpcm.bcstm"],
                                      background: "menu.webp"
                                    }
                                ]
                            },
                            {
                                name: "Experiments",
                                tracks: [
                                    { path: "tripletreat/experiments/game_music.mp3",
                                      formats: ["mp3", "dspadpcm.bcstm"],
                                      background: "experiments1.webp"
                                    },
                                    { path: "tripletreat/experiments/game_music2.mp3",
                                      formats: ["mp3", "dspadpcm.bcstm"],
                                      background: "experiments1.webp"
                                    },
                                    { path: "tripletreat/experiments/menu_music.mp3",
                                      formats: ["mp3", "dspadpcm.bcstm"],
                                      background: "experimentsmenu.webp"
                                    }
                                ]
                            },
                            {
                                name: "Time Travel",
                                tracks: [
                                    { path: "tripletreat/timetravel/music_game.mp3",
                                      formats: ["mp3", "dspadpcm.bcstm"],
                                      background: "timetravel1.webp"
                                    },
                                    { path: "tripletreat/timetravel/music_menu.mp3",
                                      formats: ["mp3", "dspadpcm.bcstm"],
                                      background: "timetravelmenu.webp"
                                    }
                                ]
                            }
                        ]
                    }
                ];
                
                this.currentsongindex = 0; this.currentcategoryindex = 0;
                this.currentsubcategoryindex = null;
                this.isplaying = false; this.isloopall = true;
                this.isloopone = false; this.isshuffled = false;
                 this.shuffledorder = []; this.looptreshold = 0.05; 
                 this.triggeredloop = false;
                this.initializepayer(); this.rendersonglist();
                this.setupeventlisteners();
            }
            getdisplayname(track) {
                const filename = track.path || "";
                if (!filename) {return "???"}
                const basename = filename.split("/").pop(); 
                return basename.replace(/\.[^/.]+$/, "");
            }
            
            createtrackelement(track, trackindex, categoryindex, subcategoryindex = null) {
                const trackelement = document.createElement("div");
                trackelement.className = "songitem";
                trackelement.dataset.categoryindex = categoryindex;
                if (subcategoryindex !== null) trackelement.dataset.subcategoryindex = subcategoryindex;
                trackelement.dataset.trackindex = trackindex;
                
                const tracknamecontainer = document.createElement("div");
                tracknamecontainer.className = "songnamecontainer";
                
                const trackname = document.createElement("div");
                trackname.className = "songname clickable";
                trackname.textContent = `${trackindex + 1}. ${this.getdisplayname(track)}`;
                
                const downloadbuttons = document.createElement("div");
                downloadbuttons.className = "downloadbuttons";
                
                track.formats.forEach(format => {
                    const downloadbutton = document.createElement("button");
                    downloadbutton.className = "downloadbutton clickable";
                    downloadbutton.dataset.format = format;
                    const displayformat = format === "dspadpcm.bcstm" ? "bcstm" : format;
                    downloadbutton.innerHTML = `<div class="extensionlabel">.${displayformat}</div><img src="/assets/images/player/icons/download.png">`;
                    downloadbuttons.appendChild(downloadbutton);
                });
                
                tracknamecontainer.appendChild(trackname);
                tracknamecontainer.appendChild(downloadbuttons);
                trackelement.appendChild(tracknamecontainer);
                
                return trackelement;
            }
            initializepayer() {this.updatebackground("menu.webp")}
            
            rendersonglist() {
                const songlist = document.querySelector(".songlist");
                songlist.innerHTML = "";
                
                this.songs.forEach((category, categoryindex) => {
                    const block = document.createElement("div");
                    block.className = "songblock";
                    const header = document.createElement("div");
                    header.className = "songblockheader";
                    const icon = document.createElement("div");
                    icon.className = "songblockicon";
                    const iconPath = category.icon.startsWith("/") ? category.icon : `/assets/images/gameicons/${category.icon}`;
                    icon.style.backgroundImage = `url(${iconPath})`;
                    icon.style.backgroundSize = "cover";
                    
                    const title = document.createElement("div");
                    title.className = "songblocktitle";
                    title.textContent = category.category;
                    
                    header.appendChild(icon);
                    header.appendChild(title);
                    
                    const trackscontainer = document.createElement("div");
                    
                    if (category.subcategories) {
                        category.subcategories.forEach((subcategory, subcategoryindex) => {
                            const subcategoryelement = document.createElement("div");
                            subcategoryelement.className = "subcategory";
                            
                            const subcategoryheader = document.createElement("div");
                            subcategoryheader.className = "subcategoryheader";
                            
                            const subcategorytitle = document.createElement("div");
                            subcategorytitle.className = "subcategorytitle";
                            subcategorytitle.textContent = subcategory.name;
                            
                            subcategoryheader.appendChild(subcategorytitle);
                            
                            subcategoryelement.appendChild(subcategoryheader);
                            
                            subcategory.tracks.forEach((track, trackindex) => {
                                subcategoryelement.appendChild(this.createtrackelement(track, trackindex, categoryindex, subcategoryindex));
                            });
                            
                            trackscontainer.appendChild(subcategoryelement);
                        });
                    } else {
                        category.tracks.forEach((track, trackindex) => {
                            trackscontainer.appendChild(this.createtrackelement(track, trackindex, categoryindex));
                        });
                    }
                    
                    block.appendChild(header);
                    block.appendChild(trackscontainer);
                    songlist.appendChild(block);
                });
            }
            
            setupeventlisteners() {
                document.addEventListener("click", (e) => {
                    const songitem = e.target.closest(".songitem");
                    if (songitem) {
                        const songname = e.target.closest(".songname");
                        if (songname) {
                            const categoryindex = parseInt(songitem.dataset.categoryindex);
                            const subcategoryindex = songitem.dataset.subcategoryindex ? parseInt(songitem.dataset.subcategoryindex) : null;
                            const trackindex = parseInt(songitem.dataset.trackindex);
                            this.playsong(categoryindex, trackindex, subcategoryindex);
                        }
                    }
                    
                    const downloadbutton = e.target.closest(".downloadbutton");
                    if (downloadbutton) {
                        const songitem = downloadbutton.closest(".songitem");
                        const categoryindex = parseInt(songitem.dataset.categoryindex);
                        const subcategoryindex = songitem.dataset.subcategoryindex ? parseInt(songitem.dataset.subcategoryindex) : null;
                        const trackindex = parseInt(songitem.dataset.trackindex);
                        
                        let song;
                        if (subcategoryindex !== null) {
                            song = this.songs[categoryindex].subcategories[subcategoryindex].tracks[trackindex];
                        } else {
                            song = this.songs[categoryindex].tracks[trackindex];
                        }
                        
                        const format = downloadbutton.dataset.format;
                        this.downloadsong(song, format);
                    }
                });
                
                // the slop onclick events
                document.querySelector(".playpausebutton").addEventListener("click", () => {
                    this.toggleplaypause();
                });
                
                document.querySelector(".prevbutton").addEventListener("click", () => {
                    this.previoussong();
                });
                
                document.querySelector(".nextbutton").addEventListener("click", () => {
                    this.nextsong();
                });
                
                document.querySelector(".loopallbutton").addEventListener("click", () => {
                    if (!this.isloopall && !this.isloopone) {this.setloopmode("all")}
                    else if (this.isloopall) {this.setloopmode("one")}
                    else {this.setloopmode("none")}
                });
                
                document.querySelector(".shufflebutton").addEventListener("click", () => {
                    this.toggleshuffle();
                });
                
                // what makes the realtime dragging work
                const progressbar = document.querySelector(".progressbar");
                let isdragging = false;
                let lastupdatetime = 0;
                progressbar.addEventListener("mousedown", (e) => {
                    isdragging = true;
                    this.seekto(e);
                });
                progressbar.addEventListener("mousemove", (e) => {
                    if (isdragging) {
                        const now = Date.now();
                        if (now - lastupdatetime > 16) {
                            this.seekto(e);
                            lastupdatetime = now;
                        }
                    }
                });
                document.addEventListener("mouseup", () => {isdragging = false});
                progressbar.addEventListener("click", (e) => {
                    if (!isdragging) {this.seekto(e)}
                });
                
                document.querySelector(".fullscreenbutton").addEventListener("click", () => {
                    this.togglefullscreen();
                });

                this.audio.addEventListener("timeupdate", () => this.updateprogress());
                this.audio.addEventListener("ended", () => this.onsongend());
                this.audio.addEventListener("loadedmetadata", () => this.updatetimedisplay());
            }
            
            playsong(categoryindex, trackindex, subcategoryindex = null) {
                this.currentcategoryindex = categoryindex;
                this.currentsongindex = trackindex;
                this.currentsubcategoryindex = subcategoryindex;
                
                let song;
                if (subcategoryindex !== null) {
                    song = this.songs[categoryindex].subcategories[subcategoryindex].tracks[trackindex];
                } else {
                    song = this.songs[categoryindex].tracks[trackindex];
                }
    
                const filename = song.path;
                if (!filename) {return}
                
                const audiopath = filename.startsWith("/") ? filename : `/assets/audio/player/${filename}`;
                
                this.preloadtracks();
                this.triggeredloop = false;
                this.audio.src = audiopath;
                
                document.querySelectorAll(".songitem").forEach(item => {
                    item.classList.remove("active");
                });
                
                const activeitem = document.querySelector(`[data-category-index="${categoryindex}"][data-track-index="${trackindex}"]`);
                if (activeitem) {
                    activeitem.classList.add("active");
                }
                
                this.updatebackground(song.background);
                
                this.audio.play().then(() => {
                    this.isplaying = true;
                    this.updateplaybutton();
                }).catch(e => {
                    console.error("Error playing audio:", e);
                });
            }
            
            toggleplaypause() {
                if (this.isplaying) {
                    this.audio.pause();
                    this.isplaying = false;
                    this.updateplaybutton();
                } else {
                    this.audio.play().then(() => {
                        this.isplaying = true;
                        this.updateplaybutton();
                    }).catch(e => {
                        console.error("Error playing audio:", e);
                    });
                }
            }
            
            previoussong() {
                let newcategoryindex = this.currentcategoryindex;
                let newsubcategoryindex = this.currentsubcategoryindex;
                let newsongindex = this.currentsongindex - 1;
                
                if (newsongindex < 0) {
                    if (newsubcategoryindex !== null && newsubcategoryindex > 0) {
                        newsubcategoryindex--;
                        newsongindex = this.songs[newcategoryindex].subcategories[newsubcategoryindex].tracks.length - 1;
                    } else if (newsubcategoryindex !== null && newsubcategoryindex === 0) {
                        newcategoryindex = (newcategoryindex - 1 + this.songs.length) % this.songs.length;
                        if (this.songs[newcategoryindex].subcategories) {
                            newsubcategoryindex = this.songs[newcategoryindex].subcategories.length - 1;
                            newsongindex = this.songs[newcategoryindex].subcategories[newsubcategoryindex].tracks.length - 1;
                        } else {
                            newsubcategoryindex = null;
                            newsongindex = this.songs[newcategoryindex].tracks.length - 1;
                        }
                    } else {
                        newcategoryindex = (newcategoryindex - 1 + this.songs.length) % this.songs.length;
                        if (this.songs[newcategoryindex].subcategories) {
                            newsubcategoryindex = this.songs[newcategoryindex].subcategories.length - 1;
                            newsongindex = this.songs[newcategoryindex].subcategories[newsubcategoryindex].tracks.length - 1;
                        } else {
                            newsubcategoryindex = null;
                            newsongindex = this.songs[newcategoryindex].tracks.length - 1;
                        }
                    }
                }
                
                this.playsong(newcategoryindex, newsongindex, newsubcategoryindex);
            }
            
            nextsong() {
                let newcategoryindex = this.currentcategoryindex;
                let newsubcategoryindex = this.currentsubcategoryindex;
                let newsongindex = this.currentsongindex + 1;
                
                let currentracklength;
                if (newsubcategoryindex !== null) {
                    currentracklength = this.songs[newcategoryindex].subcategories[newsubcategoryindex].tracks.length;
                } else {
                    currentracklength = this.songs[newcategoryindex].tracks.length;
                }
                
                if (newsongindex >= currentracklength) {
                    if (newsubcategoryindex !== null && newsubcategoryindex < this.songs[newcategoryindex].subcategories.length - 1) {
                        newsubcategoryindex++;
                        newsongindex = 0;
                    } else if (newsubcategoryindex !== null && newsubcategoryindex === this.songs[newcategoryindex].subcategories.length - 1) {
                        newcategoryindex = (newcategoryindex + 1) % this.songs.length;
                        if (this.songs[newcategoryindex].subcategories) {
                            newsubcategoryindex = 0;
                            newsongindex = 0;
                        } else {
                            newsubcategoryindex = null;
                            newsongindex = 0;
                        }
                    } else {
                        newcategoryindex = (newcategoryindex + 1) % this.songs.length;
                        if (this.songs[newcategoryindex].subcategories) {
                            newsubcategoryindex = 0;
                            newsongindex = 0;
                        } else {
                            newsubcategoryindex = null;
                            newsongindex = 0;
                        }
                    }
                }
                if (this.nextAudio.src && this.nextAudio.readyState >= 2) {
                    this.swapaudioelements();
                }; this.playsong(newcategoryindex, newsongindex, newsubcategoryindex);
            }
            swapaudioelements() {
                const tempaudio = this.audio;
                this.audio = this.nextAudio;
                this.nextAudio = tempaudio;
                document.querySelector(".audioplayer").remove();
                document.body.appendChild(this.audio);
                this.audio.className = "audioplayer";
                this.audio.addEventListener("timeupdate", () => this.updateprogress());
                this.audio.addEventListener("ended", () => this.onsongend());
                this.audio.addEventListener("loadedmetadata", () => this.updatetimedisplay());
                
                this.audio.play().then(() => {
                    this.isplaying = true;
                    this.updateplaybutton();
                }).catch(e => {
                    console.error("error playing audio??", e);
                });
            }
            
            setloopmode(mode) {
                this.isloopall = mode === "all";
                this.isloopone = mode === "one";
                
                const loopbutton = document.querySelector(".loopallbutton");
                if (this.isloopall) {
                    loopbutton.classList.add("active");
                    loopbutton.querySelector("img").src = "/assets/images/player/icons/loop.png";
                } else if (this.isloopone) {
                    loopbutton.classList.add("active");
                    loopbutton.querySelector("img").src = "/assets/images/player/icons/loopone.png";
                } else {
                    loopbutton.classList.remove("active");
                    loopbutton.querySelector("img").src = "/assets/images/player/icons/loop.png";
                }
            }
            
            toggleshuffle() {
                this.isshuffled = !this.isshuffled;
                document.querySelector(".shufflebutton").classList.toggle("active", this.isshuffled);
                
                if (this.isshuffled) {
                    this.generateshuffledorder();
                }
            }
            
            generateshuffledorder() {
                this.shuffledorder = [];
                this.songs.forEach((category, categoryindex) => {
                    if (category.subcategories) {
                        category.subcategories.forEach((subcategory, subcategoryindex) => {
                            subcategory.tracks.forEach((track, trackindex) => {
                                this.shuffledorder.push({ categoryindex, subcategoryindex, trackindex });
                            });
                        });
                    } else {
                        category.tracks.forEach((track, trackindex) => {
                            this.shuffledorder.push({ categoryindex, subcategoryindex: null, trackindex });
                        });
                    }
                });
                
                for (let i = this.shuffledorder.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [this.shuffledorder[i], this.shuffledorder[j]] = [this.shuffledorder[j], this.shuffledorder[i]];
                }
            }
            
            preloadtracks() {
                let nextcategoryindex = this.currentcategoryindex;
                let nextsubcategoryindex= this.currentsubcategoryindex;
                let nextsongindex = this.currentsongindex + 1;
                
                 let currentracklength;
                 if (nextsubcategoryindex !== null) {
                     currentracklength = this.songs[nextcategoryindex].subcategories[nextsubcategoryindex].tracks.length;
                 } else {
                     currentracklength = this.songs[nextcategoryindex].tracks.length;
                 }
                 
                 if (nextsongindex >= currentracklength) {
                     if (nextsubcategoryindex !== null && nextsubcategoryindex < this.songs[nextcategoryindex].subcategories.length - 1) {
                         nextsubcategoryindex++;
                         nextsongindex = 0;
                     } else if (nextsubcategoryindex !== null && nextsubcategoryindex === this.songs[nextcategoryindex].subcategories.length - 1) {
                         nextcategoryindex = (nextcategoryindex + 1) % this.songs.length;
                         if (this.songs[nextcategoryindex].subcategories) {
                             nextsubcategoryindex = 0;
                             nextsongindex = 0;
                         } else {
                             nextsubcategoryindex = null;
                             nextsongindex = 0;
                         }
                     } else {
                         nextcategoryindex = (nextcategoryindex + 1) % this.songs.length;
                         if (this.songs[nextcategoryindex].subcategories) {
                             nextsubcategoryindex = 0;
                             nextsongindex = 0;
                         } else {
                             nextsubcategoryindex = null;
                             nextsongindex = 0;
                         }
                     }
                }
                let nextsong;
                if (nextsubcategoryindex !== null) {
                    nextsong = this.songs[nextcategoryindex].subcategories[nextsubcategoryindex].tracks[nextsongindex];
                } else {
                    nextsong = this.songs[nextcategoryindex].tracks[nextsongindex];
                }
                if (nextsong && nextsong.path) {
                    const nextAudioPath = nextsong.path.startsWith("/") ? nextsong.path : `/assets/audio/player/${nextsong.path}`;
                    this.nextAudio.src = nextAudioPath;
                }
            }
            
             coolloop() {
                 if (this.isloopone) {
                     this.audio.currentTime = 0;
                     this.triggeredloop = false;
                     if (this.isplaying) {
                         this.audio.play().catch(e => console.error("loop error:", e));
                     }
                 } else if (this.isloopall || this.isshuffled) {
                    if (this.isshuffled) {
                        const currentIndex = this.shuffledorder.findIndex(item => 
                            item.categoryindex === this.currentcategoryindex && 
                            item.subcategoryindex === this.currentsubcategoryindex && 
                            item.trackindex === this.currentsongindex
                        );
                        
                        if (currentIndex !== -1) {
                            const nextIndex = (currentIndex + 1) % this.shuffledorder.length;
                            const nextsong = this.shuffledorder[nextIndex];
                            this.playsong(nextsong.categoryindex, nextsong.trackindex, nextsong.subcategoryindex);
                        } else {
                            this.nextsong();
                        }
                    } else {
                        this.nextsong();
                    }
                }
            }; onsongend() {this.coolloop()}
            
            updateplaybutton() {
                const playpausebutton = document.querySelector(".playpausebutton");
                const img = playpausebutton.querySelector("img");
                img.src = this.isplaying ? "/assets/images/player/icons/pause.png" : "/assets/images/player/icons/play.png";
            }
            
            updateprogress() {
                if (this.audio.duration) {
                    const progress = (this.audio.currentTime / this.audio.duration) * 100;
                    const progressfillcontainer = document.querySelector(".progressfillcontainer");
                    const progressfill = document.querySelector(".progressfill");
                    progressfillcontainer.style.width = `${progress}%`;
                    progressfill.style.setProperty("--progress", progress / 100);
                    
                     if (this.audio.currentTime >= this.audio.duration - this.looptreshold && !this.triggeredloop) {
                         console.log("Triggering seamless loop at", this.audio.currentTime, "duration:", this.audio.duration, "mode:", this.isloopone ? "single" : "playlist");
                         this.triggeredloop = true; this.coolloop();
                     }
                }
                this.updatetimedisplay();
            }
            
            updatetimedisplay() {
                const current = this.formattime(this.audio.currentTime || 0);
                const duration = this.formattime(this.audio.duration || 0);
                document.querySelector(".timedisplay").textContent = `${current}/${duration}`;
            }
            
            formattime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, "0")}`;
            }
            
            seekto(e) {
                if (this.audio.duration) {
                    const rect = e.currentTarget.getBoundingClientRect();
                    const clickx = e.clientX - rect.left;
                    const percentage = clickx / rect.width;
                    this.audio.currentTime = percentage * this.audio.duration;
                }
            }
            
            updatebackground(imageurl) {
                const stupidbg = document.querySelector(".stupidbg");
                if (imageurl) {
                    const bgpath = imageurl.startsWith("/") ? imageurl : `/assets/images/player/bgs/${imageurl}`;
                    const currentbg = stupidbg.style.backgroundImage;
                    if (currentbg === `url("${bgpath}")` || currentbg === `url(${bgpath})`) {return}
                    
                    const newbg = document.createElement("div");
                    newbg.className = "stupidbg";
                    newbg.style.backgroundImage = `url(${bgpath})`;
                    newbg.style.opacity = "0";
                    newbg.style.transition = "opacity 1s ease-in-out";
                    document.body.insertBefore(newbg, stupidbg);

                    setTimeout(() => {
                        newbg.style.opacity = "1";
                        stupidbg.style.opacity = "0";
                    }, 50);
                    setTimeout(() => {
                        if (stupidbg.parentNode) {
                            stupidbg.parentNode.removeChild(stupidbg);
                        }
                    }, 1100);
                } else {
                    if (stupidbg.style.backgroundImage === "none") {return}
                    
                    stupidbg.style.opacity = "0";
                    setTimeout(() => {
                        stupidbg.style.backgroundImage = "none";
                        stupidbg.style.opacity = "1";
                    }, 500);
                }
            }
            
            togglefullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            }
            
            downloadsong(song, format) {
                const filename = song.path;
                if (!filename) {return}
                
                const audiopath = filename.startsWith("/") ? filename : `/assets/audio/player/${filename}`;
                const downloadurl = audiopath.replace(/\.\w+$/, `.${format}`);
                
                const link = document.createElement("a");
                link.href = downloadurl;
                link.download = `${this.getdisplayname(song)}.${format}`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
        }
        
        window.addEventListener("load", function() {
            const loading = document.querySelector(".loading");
            if (loading) {
                loading.style.opacity = "0";
                setTimeout(function() {
                    if (loading.parentNode) {
                        loading.parentNode.removeChild(loading);
                    }
                }, 500);
            }; window.musicplayer = new musicplayer();
        });
    </script>
</body>
</html>